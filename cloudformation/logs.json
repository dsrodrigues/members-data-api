{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Template for the Identity stack Logs.",
  "Parameters": {
    "OperatorEmail": {
      "Description": "Email address to notify if there are any alarm events",
      "Type": "String"
    },
    "Stage": {
      "Description": "Environment name",
      "Type": "String",
      "AllowedValues": [ "CODE", "PROD" ]
    }
  },

  "Resources": {
    "membershipAttributesServiceRequests2xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=2*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "requests_2xx",
            "MetricValue": 1
          }
        ]
      }
    },
    "membershipAttributesServiceRequests4xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=4*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "requests_4xx",
            "MetricValue": 1
          }
        ]
      }
    },
    "membershipAttributesServiceRequests5xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=5*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "requests_5xx",
            "MetricValue": 1
          } 
        ] 
      } 
    },


    "membershipAttributesServiceLatency2xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=2*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "request_latency_2xx",
            "MetricValue": "$time"
          }
        ]
      }
    },    
    "membershipAttributesServiceLatency4xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=4*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "request_latency_4xx",
            "MetricValue": "$time"
          }
        ]
      }
    },
    "membershipAttributesServiceLatency5xx": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "[..., type=REQUEST, remoteAddr, method, uri!=\"/healthcheck\", took=took, time, ms=ms, and=and, returned=returned, statusCode=5*]",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "request_latency_5xx",
            "MetricValue": "$time"
          }
        ]
      }
    },

    "membershipAttributesServiceErrors": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ "identity-membership-attribute-service-", { "Ref": "Stage" } ]]},
        "FilterPattern": "ERROR",
        "MetricTransformations": [
          {
            "MetricNamespace": { "Fn::Join": [ "", [ { "Ref": "Stage" }, "/user-attributes"] ]},
            "MetricName": "errors",
            "MetricValue": 1
          }
        ]
      }
    },

    "alarmNotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [
          {
            "Endpoint": { "Ref": "OperatorEmail" },
            "Protocol": "email"
          }
        ]
      }
    }
  }
}
